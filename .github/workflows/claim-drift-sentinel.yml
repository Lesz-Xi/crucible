name: Claim Drift Sentinel

on:
  pull_request:
  push:
    branches: ["main"]
  schedule:
    - cron: "20 2 * * *"
  workflow_dispatch:

env:
  ROLLOUT_STAGE: week2

jobs:
  drift-scan:
    name: Claim Drift Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Resolve rollout mode
        id: rollout
        run: |
          stage="${ROLLOUT_STAGE}"
          event="${GITHUB_EVENT_NAME}"
          mode="report"

          if [ "$stage" = "week3" ]; then
            mode="enforce"
          elif [ "$stage" = "week2" ] && [ "$event" = "pull_request" ]; then
            mode="enforce"
          fi

          echo "stage=$stage" >> "$GITHUB_OUTPUT"
          echo "mode=$mode" >> "$GITHUB_OUTPUT"

      - name: Run claim drift scanner
        id: scan
        run: |
          set +e
          npm run governance:claim-drift -- --mode "${{ steps.rollout.outputs.mode }}" --strict critical --format json,md
          exit_code=$?
          set -e
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"
          if [ "$exit_code" -ne 0 ]; then
            exit "$exit_code"
          fi

      - name: Upload drift artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claim-drift-report-${{ github.run_number }}
          path: |
            artifacts/claim-drift-report.json
            artifacts/claim-drift-report.md
          retention-days: 30

      - name: Publish summary
        if: always()
        run: |
          echo "## Claim Drift Sentinel" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Rollout stage: ${{ steps.rollout.outputs.stage }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Effective mode: ${{ steps.rollout.outputs.mode }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Scanner exit code: ${{ steps.scan.outputs.exit_code }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.scan.outputs.exit_code }}" = "0" ]; then
            echo "✅ No blocking claim drift detected for current mode." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "❌ Claim drift scanner reported blocking issues." >> "$GITHUB_STEP_SUMMARY"
          fi
