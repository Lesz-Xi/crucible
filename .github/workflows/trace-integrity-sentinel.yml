name: Trace Integrity Sentinel

on:
  pull_request:
  push:
    branches: ["main"]
  schedule:
    - cron: "50 2 * * *"
  workflow_dispatch:

env:
  ROLLOUT_STAGE: week2
  TRACE_SOURCE: hybrid
  TRACE_FIXTURES_PATH: docs/governance/trace-fixtures.v1.json
  TRACE_SCAN_LIMIT: "100"

jobs:
  trace-scan:
    name: Trace Integrity Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Resolve rollout mode
        id: rollout
        run: |
          stage="${ROLLOUT_STAGE}"
          event="${GITHUB_EVENT_NAME}"
          mode="report"

          if [ "$stage" = "week3" ]; then
            mode="enforce"
          elif [ "$stage" = "week2" ] && [ "$event" = "pull_request" ]; then
            mode="enforce"
          fi

          echo "stage=$stage" >> "$GITHUB_OUTPUT"
          echo "mode=$mode" >> "$GITHUB_OUTPUT"

      - name: Resolve source mode
        id: source
        run: |
          source="${TRACE_SOURCE}"
          fixtures="${TRACE_FIXTURES_PATH}"

          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ] && [[ "${GITHUB_HEAD_REF}" == "codex/trace-governance-exercise"* ]]; then
            source="fixture"
            fixtures="docs/governance/trace-fixtures.exercise.v1.json"
          fi

          echo "source=$source" >> "$GITHUB_OUTPUT"
          echo "fixtures=$fixtures" >> "$GITHUB_OUTPUT"

      - name: Run trace integrity scanner
        id: scan
        run: |
          set +e
          npm run governance:trace-integrity -- \
            --mode "${{ steps.rollout.outputs.mode }}" \
            --source "${{ steps.source.outputs.source }}" \
            --fixtures "${{ steps.source.outputs.fixtures }}" \
            --strict critical \
            --rollout-stage "${{ steps.rollout.outputs.stage }}" \
            --limit "${TRACE_SCAN_LIMIT}"
          exit_code=$?
          set -e
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"
          if [ "$exit_code" -ne 0 ]; then
            exit "$exit_code"
          fi

      - name: Upload trace artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trace-integrity-report-${{ github.run_number }}
          path: |
            artifacts/trace-integrity-report.json
            artifacts/trace-integrity-report.md
            artifacts/trace-integrity-trend.csv
          retention-days: 30

      - name: Publish summary
        if: always()
        run: |
          echo "## Trace Integrity Sentinel" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Rollout stage: ${{ steps.rollout.outputs.stage }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Effective mode: ${{ steps.rollout.outputs.mode }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Source: ${{ steps.source.outputs.source }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Fixtures: ${{ steps.source.outputs.fixtures }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Scanner exit code: ${{ steps.scan.outputs.exit_code }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.scan.outputs.exit_code }}" = "0" ]; then
            echo "✅ No blocking trace integrity drift detected for current mode." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "❌ Trace integrity scanner reported blocking issues." >> "$GITHUB_STEP_SUMMARY"
          fi
