name: Hybrid Novelty Proof Sentinel

on:
  pull_request:
  push:
    branches: ["main"]
  schedule:
    - cron: "35 2 * * *"
  workflow_dispatch:

env:
  ROLLOUT_STAGE: week1

jobs:
  novelty-proof-scan:
    name: Hybrid Novelty Proof Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Resolve rollout mode
        id: rollout
        run: |
          stage="${ROLLOUT_STAGE}"
          event="${GITHUB_EVENT_NAME}"
          mode="report"

          if [ "$stage" = "week3" ]; then
            mode="enforce"
          elif [ "$stage" = "week2" ] && [ "$event" = "pull_request" ]; then
            mode="enforce"
          fi

          echo "stage=$stage" >> "$GITHUB_OUTPUT"
          echo "mode=$mode" >> "$GITHUB_OUTPUT"

      - name: Run novelty proof evaluator
        id: eval
        run: |
          set +e
          npx --yes tsx scripts/evaluate-hybrid-novelty-proof.ts \
            --scenarioPack docs/governance/hybrid-novelty.scenarios.v1.json \
            --seed 20260212 \
            --mode "${{ steps.rollout.outputs.mode }}" \
            --format json,md,csv \
            --outputDir artifacts/governance/hybrid-novelty
          exit_code=$?
          set -e
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"
          if [ "$exit_code" -ne 0 ]; then
            exit "$exit_code"
          fi

      - name: Upload novelty artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hybrid-novelty-report-${{ github.run_number }}
          path: |
            artifacts/governance/hybrid-novelty/hybrid-novelty-report.json
            artifacts/governance/hybrid-novelty/hybrid-novelty-report.md
            artifacts/governance/hybrid-novelty/hybrid-novelty-trend.csv
          retention-days: 30

      - name: Publish summary
        if: always()
        run: |
          echo "## Hybrid Novelty Proof Sentinel" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Rollout stage: ${{ steps.rollout.outputs.stage }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Effective mode: ${{ steps.rollout.outputs.mode }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Evaluator exit code: ${{ steps.eval.outputs.exit_code }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.eval.outputs.exit_code }}" = "0" ]; then
            echo "✅ Novelty proof evaluator completed successfully." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "❌ Novelty proof evaluator reported blocking failures." >> "$GITHUB_STEP_SUMMARY"
          fi
